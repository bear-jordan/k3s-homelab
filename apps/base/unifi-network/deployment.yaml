apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: unifi-network
  name: unifi-network
spec:
  replicas: 1
  selector:
    matchLabels:
      app: unifi-network
  template:
    metadata:
      labels:
        app: unifi-network
    spec:
      containers:
        - image: lscr.io/linuxserver/unifi-network-application:latest
          name: unifi-network
          ports:
            - containerPort: 8080
            - containerPort: 8443
            - containerPort: 3478
              protocol: UDP
            - containerPort: 10001
              protocol: UDP
          volumeMounts:
            - name: unifi-data-pvc
              mountPath: /config
          envFrom:
            - secretRef:
                name: mongo-credentials
            - configMapRef:
                name: config
        - name: mongos
          image: mongo:4.4
          command:
            - "mongos"
            - "--configdb"
            - "mongodb-replica-set/mongo-0.mongodb-replica-set-svc.mongodb.svc.cluster.local:27017,mongo-1.mongodb-replica-set-svc.mongodb.svc.cluster.local:27017,mongo-2.mongodb-replica-set-svc.mongodb.svc.cluster.local:27017"
          ports:
            - containerPort: 27017
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"
      volumes:
        - name: unifi-data-pvc
          persistentVolumeClaim:
            claimName: unifi-data-pvc
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: config
data:
  PGID: "1000"
  PUID: "1000"
  TZ: Etc/UTC
  MONGO_PORT: "27017"
  MONGO_DBNAME: unifi
  MONGO_USER: unifi
  MONGO_HOST: localhost
  MONGO_AUTHSOURCE: unifi
  MONGO_TLS: "false"
